; tox configuration file for running tests similar to buildbot builders.

[tox]
skip_missing_interpreters=True
toxworkdir=build/
envlist=
        {py27,py33,py34,py35}-{tests,nomodules,coverage}-posix
        py27-{tests,nomodules,coverage}-windows,
        pyflakes,twistedchecker,apidocs,narrativedocs,topfile

[testenv]
changedir={envtmpdir}
deps =
    ; Some relatively standard dependencies that we want to have when running
    ; the test with trial.
    ; Anything which depend on Twisted itself is delayed (ex pydoctor) as
    ; otherwise the test will be executed for the released Twisted version.
    {tests,coverage}: cryptography >= 0.9
    {tests,coverage}: pyopenssl >= 0.13
    {tests,coverage}: service_identity
    {tests,coverage}: idna >= 0.6
    {tests,coverage}: pyserial
    {tests,coverage}: python-subunit
    {tests,coverage}: pycrypto
    {tests,coverage}: appdirs
    {tests,coverage}: h2
    {tests,coverage}: priority

    py27-{tests,coverage}-posix: pysqlite
    py27-{tests,coverage}: soappy

    windows: pypiwin32

    coverage: coverage

    ; Code quality checkers
    pyflakes: pyflakes
    twistedchecker: twistedchecker

    ; Documentation
    apidocs: pydoctor
    narrativedocs: sphinx

setenv =
   COVERAGE_PROCESS_START = {toxinidir}/.coveragerc

commands =

    ; pydoctor installation needs to be delayed after the working dir is
    ; installed otherwise it will install the upstream Twisted release and
    ; the tests will be executed from there.
    ; This step should not produce any output as otherwise the Buildbot trial
    ; step will fail to extrat the test results.
    py27-{tests,coverage}: {envbindir}/pip install -q pydoctor

    ; Make sure that no output is made before calling the trial command as the
    ; Buildbot step will fail.
    ; See: https://github.com/twisted-infra/braid/issues/211
    {tests,nomodules}: {envbindir}/trial --reactor={env:TWISTED_REACTOR:default} --reporter={env:TRIAL_REPORTER:verbose}  {posargs:twisted}

    coverage: python {toxinidir}/admin/_copy.py {toxinidir}/admin/zz_coverage.pth {envsitepackagesdir}/zz_coverage.pth
    coverage: coverage erase
    coverage: coverage run -p --rcfile={toxinidir}/.coveragerc {envbindir}/trial --reactor={env:TWISTED_REACTOR:default} --reporter={env:TRIAL_REPORTER:verbose} {posargs:twisted}
    coverage: python {toxinidir}/admin/_copy.py "_trial_temp/.coverage*" {toxinidir}
    coverage: python {toxinidir}/admin/_copy.py ".coverage*" {toxinidir}

    twistedchecker: twistedchecker {posargs:twisted}
    pyflakes: pyflakes {posargs:twisted admin bin}

    apidocs: {toxinidir}/bin/admin/build-apidocs {toxinidir} apidocs
    narrativedocs: sphinx-build -aW -b html -d {toxinidir}/docs/_build {toxinidir}/docs {toxinidir}/docs/_build/

    topfile: python {toxinidir}/bin/admin/check-topfile "{toxinidir}"

[testenv:twistedchecker]
basepython=python2.7
changedir={toxinidir}
[testenv:pyflakes]
basepython=python2.7
changedir={toxinidir}
[testenv:apidocs]
basepython=python2.7
[testenv:topfile]
basepython=python2.7
changedir={toxinidir}

[tox:travis]
; This section is used by tox-travis
; https://pypi.python.org/pypi/tox-travis
2.7 = py27-coverage-posix,py27-nomodules-posix,topfile,narrativedocs,pyflakes
3.3 = py33-coverage-posix
3.4 = py34-coverage-posix
3.5 = py35-coverage-posix